# DGMD E-14 Final Project - Python
This project contains Python scripts  

Note that all the scripts are written to run on my home system, so they assume the following folder structure exists:
* (parent directory)\color - contains all color-related label files, sorted image directories, and output
* (parent directory)\shape - contains all shape-related label files, sorted image directories, and output
* (parent_directory)\ocr - contains all OCR-related label files
* (parent_directory)\ocr\outputs - directory in which all accuracy output files should be created
* (parent directory)\images\C3PI full data - directory in which the C3PI images have been downloaded, maintaining the
same directory structure as on the [C3PI download website](https://data.lhncbc.nlm.nih.gov/public/Pills/index.html)

# OCR
## Requirements
Some libraries are required to run any of the scripts, while some are only required for the particular OCR library.

### Shared
These libraries will be used by prediction or test scripts for both OCR models.

* imutils (image manipulation utilities)
* levenshtein (string distance calculation)
* numpy
* pandas
* opencv-python/opencv-python-headless

Note that if opencv-python is installed, both will install opencv-python-headless as well.

### EasyOCR
EasyOCR requires PyTorch.  This includes torch, torchaudio, and torchvision.  If running on Windows, PyTorch must 
be installed first.

* torch
* torchaudio
* torchvision
* easyocr

### keras-ocr
keras-ocr requires TensorFlow.  It's probably best to pre-install this to ensure you get the appropriate version for
CPU vs GPU, and to ensure you have any additional pre-requisites for TensorFlow itself.  
https://www.tensorflow.org/install

* tensorflow (this is the GPU version, for CPU-only use tensorflow-cpu - follow install instructions)
* keras-ocr

### PyTesseract
PyTesseract requires a separate installation of the Google Tesseract engine.  If the tesseract executable isn't added
to the system path, the `generate_ocr()` method must be run to specify the directory containing the executable.

* pytesseract

## Usage/Scripts
For each OCR library, there's an associated "X_predict.py" and "X_accuracy.py" module.  There's an additional 
"test_utils.py" module containing functions shared across both "X_accuracy.py" modules.

### X_predict.py
This module contains functions used to generate predictions from an image file using the specific OCR library.

#### `generate_ocr()`
For both EasyOCR and keras-ocr, the `generate_ocr()` function must be called first, to create the OCR object that will
be used to do the predictions.  This is done separately from the actual `generate_predictions()` function to 
facilitate reuse for batch testing.

For PyTesseract, this function doesn't create an OCR object, but instead sets the path of the directory containing the 
tesseract executable that will be used by PyTesseract.

The `generate_ocr()` function may or may not take arguments - check the specific module.

#### `generate_predictions()`
This is the function that should be called to generate text predictions for a single image file.

The `generate_predictions()` function has the same signature for all libraries:  
```python
def generate_predictions(ocr, image_file: str, rotate=False) -> List[List[str]]:
```
This function takes the OCR object generated by `generate_ocr()` (if any), the path to the image file for which OCR 
predictions should be generated, and an optional flag indicating whether additional permutations of the image should be
generated at 90, 180, and 270 degree rotations.  (This flag is mainly intended for use with batch testing of provided 
test images, which may be in different orientations - it defaults to False.)

Each permutation will result in a List of predicted "words" in the image.  The function returns a List containing all 
of these Lists, one per permutation.  At minimum, there will be two permutations, one for the original image and one 
for a sharpened version of the image.  If rotate is True, there will be eight permutations, one for each orientation of
original and sharpened image version.

### test_utils.py
This module contains a bunch of functions useful for batch testing accuracy of the models.

### X_accuracy.py
This module contains the batch prediction generation and accuracy calculations for each OCR library.

#### `run_test_c3pi_original()`
For all three libraries, there's a function with the signature:
```python
def run_test_c3pi_original(parent_folder: str, text_file_name: str, sample: bool = False, head: bool = False,
                           n_entries: int = None, start_index: int = None) -> None:
```
This method is used to run predictions against all files 

The `parent_folder` should be the master directory in which all the OCR labels, output, and images are found.  See the 
note at the beginnng about the expected folder structure.

It assumes that `text_file_name` will be the name of a CSV file provided in the format:  
"(C3PI directory)", "(Image file name)", (Imprint rating), (Imprint type), "(Imprint text)", (NDC11), (Part)

Generated DataFrame columns:  
`["image_dir", "image_file", "imprint_rating", "imprint_type", "imprint", "ndc11", "part", "file_path"]`

The file_path column contains the full path for that image, and will be used by other test methods to load the image.

Note that (Imprint rating), (Imprint type), and (Imprint text) may all be null.  If (Imprint rating) is null, it will 
be replaced with "Empty" for accuracy calculation across imprint rating groups.

#### `run_test_spl_front_square()`
For EasyOCR and keras-ocr, there's an additional function with the signature:
```python
def run_test_spl_front_square(parent_folder: str, text_file_name: str, image_parent_dir: str,
                              sample: bool = False, head: bool = False,
                              n_entries: int = None, start_index: int = None) -> None:
```


